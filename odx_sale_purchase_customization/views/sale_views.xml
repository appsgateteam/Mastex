<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
        <!-- Inherit Sale Order Form View to Modify it -->
        <record id="view_order_form_inherit" model="ir.ui.view">
            <field name="name">sale.order.form.inherit</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <xpath expr="//sheet/group" position="inside">
                    <group>
                        <field name="vendor_id" widget="res_partner_many2one"
                               context="{'res_partner_search_mode': 'supplier', 'show_vat': True}"
                               placeholder="Name, TIN, Email, or Reference"
                               attrs="{'readonly': [('state', 'not in', ('draft', 'sent'))],'required': True}"
                               domain="[('supplier_rank','=',1)]"/>
                        <field name="purchase_order_id" readonly="1"/>
                    </group>
                    <group>
                        <field name="shipment" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                        <field name="payment" attrs="{'readonly':[('state', 'in', 'sale')]}"/>

                    </group>
                    <group>
                        <field name="insurance_id" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                        <field name="destination_id" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                        <field name="marks_id" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                    </group>
                </xpath>
                <xpath expr="//field[@name='partner_id']" position="attributes">
                    <attribute name="domain">[('customer_rank','=',1)]</attribute>
                    <attribute name="context">{'res_partner_search_mode': 'customer', 'show_address': 1, 'show_vat':
                        True,'default_customer_rank':1}
                    </attribute>
                </xpath>

                <xpath expr="//form/sheet/notebook/page[@name='other_information']" position="after">
                    <page string="Instructions" name="instructions_tab">
                        <group>
                            <field name="colour_instructions" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                            <field name="packing" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                            <field name="face_stamp" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                            <field name="selvedge" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                        </group>
                        <group>
                            <field name="shipping_mark" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                            <field name="shipping_sample_book" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                            <field name="notes" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                        </group>
                    </page>
                </xpath>
                <xpath expr="//field[@name='order_line']/tree" position="replace">
                    <tree
                            string="Sales Order Lines"
                            editable="bottom"
                            decoration-info="(not display_type and invoice_status == 'to invoice')"
                    >
                        <control>
                            <create name="add_product_control" string="Add a product"/>
                            <create name="add_section_control" string="Add a section"
                                    context="{'default_display_type': 'line_section'}"/>
                            <create name="add_note_control" string="Add a note"
                                    context="{'default_display_type': 'line_note'}"/>
                        </control>

                        <field name="sequence" widget="handle" attrs="{'readonly':[('state', 'in', 'sale')]}"/>
                        <!-- We do not display the type because we don't want the user to be bothered with that information if he has no section or note. -->
                        <field name="display_type" invisible="1"/>
                        <field name="product_uom_category_id" invisible="1"/>

                        <field name="product_updatable" invisible="1"/>
                        <field
                                name="product_id"
                                attrs="{
                                            'readonly': ['|',('product_updatable', '=', False),('state', 'in', 'sale')],
                                            'required': [('display_type', '=', False)],
                                        }"
                                options="{'no_open': True}"
                                force_save="1"
                                context="{
                                            'partner_id': parent.partner_id,
                                            'quantity': product_uom_qty,
                                            'pricelist': parent.pricelist_id,
                                            'uom':product_uom,
                                            'company_id': parent.company_id,
                                            'default_lst_price': price_unit,
                                            'default_description_sale': name
                                        }"
                                domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                                widget="product_configurator"
                        />
                        <field name="product_template_id"
                               string="Product"
                               invisible="1"
                               attrs="{
                                          'readonly': ['|',('product_updatable', '=', False),('state', 'in', 'sale')],
                                          'required': [('display_type', '=', False)],
                                      }"
                               options="{'no_open': True}"
                               context="{
                                          'partner_id': parent.partner_id,
                                          'quantity': product_uom_qty,
                                          'pricelist': parent.pricelist_id,
                                          'uom':product_uom,
                                          'company_id': parent.company_id,
                                          'default_list_price': price_unit,
                                          'default_description_sale': name
                                      }"
                               domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                               widget="product_configurator"/>
                        <field name="name" widget="section_and_note_text"
                               attrs="{'readonly':[('state', 'in', 'sale')]}" optional="show"/>
                        <field
                                name="analytic_tag_ids"
                                optional="hide"
                                groups="analytic.group_analytic_tags"
                                widget="many2many_tags"
                                attrs="{'readonly':[('state', 'in', 'sale')]}"
                                options="{'color_field': 'color'}"
                                domain="['|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                        />
                        <field
                                name="product_uom_qty"
                                context="{
                                            'partner_id': parent.partner_id,
                                            'quantity': product_uom_qty,
                                            'pricelist': parent.pricelist_id,
                                            'uom': product_uom,
                                            'company_id': parent.company_id
                                        }"
                                attrs="{'readonly':[('state', 'in', 'sale')]}"
                        />
                        <field name="actual_qty" attrs="{'readonly': [('parent.state', 'not in', ['sale', 'done'])]}"/>
                        <field name="attachment_ids" widget="many2many_binary" options="{'no_create': False}"/>
                        <field
                                name="qty_delivered"
                                string="Delivered"
                                attrs="{
                                            'column_invisible': [('parent.state', 'not in', ['sale', 'done'])],
                                            'readonly': ['|',('qty_delivered_method', '!=', 'manual'),('state', 'in', 'sale')]
                                        }"
                                optional="show" invisible="1"
                        />
                        <field name="qty_delivered_manual" invisible="1"/>
                        <field name="qty_delivered_method" invisible="1"/>
                        <field
                                name="qty_invoiced"
                                string="Invoiced"
                                attrs="{'column_invisible': [('parent.state', 'not in', ['sale', 'done'])]}"
                                optional="show"
                        />
                        <field name="qty_to_invoice" invisible="1"/>
                        <field
                                name="product_uom"
                                force_save="1"
                                string="UoM"
                                attrs="{
                                            'readonly': [('state', 'in', ('sale','done', 'cancel'))],
                                            'required': [('display_type', '=', False)],
                                        }"
                                context="{'company_id': parent.company_id}"
                                groups="uom.group_uom"
                                options='{"no_open": True}'
                                optional="show"
                        />
                        <field
                                name="customer_lead"
                                optional="hide"
                                attrs="{'readonly': [('parent.state', 'not in', ['draft', 'sent'])]}"
                        />
                        <field
                                name="price_unit"
                                attrs="{'readonly': ['|',('qty_invoiced', '&gt;', 0),('parent.state', 'not in', ['draft', 'sent'])]}"
                        />
                        <field
                                name="tax_id"
                                widget="many2many_tags"
                                options="{'no_create': True}"
                                domain="[('type_tax_use','=','sale'),('company_id','=',parent.company_id)]"
                                attrs="{'readonly': ['|',('qty_invoiced', '&gt;', 0), ('parent.state', 'not in', ['draft', 'sent'])]}"
                                optional="show"
                        />
                        <field name="discount" string="Disc.%" groups="product.group_discount_per_so_line"
                               optional="show"
                               attrs="{'readonly': [('parent.state', 'not in', ['draft', 'sent'])]}"/>
                        <field name="price_subtotal" widget="monetary"
                               groups="account.group_show_line_subtotals_tax_excluded"/>
                        <field name="price_total" widget="monetary"
                               groups="account.group_show_line_subtotals_tax_included"/>
                        <field name="state" invisible="1"/>
                        <field name="invoice_status" invisible="1"/>
                        <field name="currency_id" invisible="1"/>
                        <field name="price_tax" invisible="1"/>
                        <field name="company_id" invisible="1"/>
                    </tree>
                </xpath>
                <xpath expr="//field[@name='order_line']/form//field[@name='qty_delivered']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
            </field>
        </record>

<!--        <record model="ir.ui.view" id="sale_margin_sale_order_line_form">-->
<!--            <field name="name">sale.order.line.tree.margin.view.form</field>-->
<!--            <field name="model">sale.order</field>-->
<!--            <field name="inherit_id" ref="sale.view_order_form"/>-->
<!--            <field name="arch" type="xml">-->
<!--                <xpath expr="//field[@name='order_line']/tree//field[@name='product_uom_qty']" position="after">-->
<!--                    <field name="actual_qty" attrs="{'readonly': [('state', 'in', ('sale','done', 'cancel'))]}"/>-->
<!--                    <field name="attachment_ids" widget="many2many_tags" options="{'no_create': False}"/>-->
<!--                </xpath>-->
<!--                <xpath expr="//field[@name='order_line']/tree//field[@name='qty_delivered']" position="attributes">-->
<!--                    <attribute name="invisible">1</attribute>-->
<!--                </xpath>-->

<!--                <xpath expr="//field[@name='order_line']/form//field[@name='qty_delivered']" position="attributes">-->
<!--                    <attribute name="invisible">1</attribute>-->
<!--                </xpath>-->
<!--                <xpath expr="//field[@name='order_line']/form//field[@name='product_uom_qty']" position="after">-->
<!--                    <field name="actual_qty" attrs="{'readonly': [('state', 'in', ('sale','done', 'cancel'))]}"/>-->
<!--                    <field name="attachment_ids" widget="many2many_tags" options="{'no_create': False}"/>-->
<!--                </xpath>-->
<!--            </field>-->
<!--        </record>-->
    </data>
</odoo>